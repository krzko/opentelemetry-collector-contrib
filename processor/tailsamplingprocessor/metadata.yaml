type: tail_sampling

status:
  class: processor
  stability:
    beta: [traces]
  distributions: [contrib, k8s]
  codeowners:
    active: [portertech]
    emeritus: [jpkrohling]
    seeking_new: true

tests:
  config:

attributes:
  policy:
    description: Name of the policy
    type: string

  sampled:
    description: Whether the sampling decision was sampled or not, false can mean either not sampled or dropped
    type: bool

  decision:
    description: The sampling decision
    enum: [sampled, not_sampled, dropped]
    type: string

  storage_type:
    description: Type of storage backend used
    enum: [memory, redis, hybrid]
    type: string

  operation:
    description: Storage operation type
    enum: [append, fetch, lease_acquire, lease_release, decision_set, decision_get, spill, rehydrate]
    type: string

  backend:
    description: Object storage backend type
    enum: [gcs, s3]
    type: string

  error_type:
    description: Type of storage error encountered
    enum: [connection, timeout, capacity, script_error, auth, not_found]
    type: string

telemetry:
  metrics:
    processor_tail_sampling_sampling_decision_latency:
      description: Latency (in microseconds) of a given sampling policy
      unit: µs
      enabled: true
      histogram:
        value_type: int
        bucket_boundaries: [1, 2, 5, 10, 25, 50, 75, 100, 150, 200, 300, 400, 500, 750, 1000, 2000, 3000, 4000, 5000, 10000, 20000, 30000, 50000]

    processor_tail_sampling_sampling_decision_timer_latency:
      description: Latency (in milliseconds) of each run of the sampling decision timer
      unit: ms
      enabled: true
      histogram:
        value_type: int
        bucket_boundaries: [1, 2, 5, 10, 25, 50, 75, 100, 150, 200, 300, 400, 500, 750, 1000, 2000, 3000, 4000, 5000, 10000, 20000, 30000, 50000]

    processor_tail_sampling_sampling_trace_removal_age:
      description: Time (in seconds) from arrival of a new trace until its removal from memory
      unit: s
      enabled: true
      histogram:
        value_type: int

    processor_tail_sampling_sampling_late_span_age:
      description: Time (in seconds) from the sampling decision was taken and the arrival of a late span
      unit: s
      enabled: true
      histogram:
        value_type: int

    processor_tail_sampling_sampling_policy_evaluation_error:
      description: Count of sampling policy evaluation errors
      unit: "{errors}"
      enabled: true
      sum:
        value_type: int
        monotonic: true

    processor_tail_sampling_count_traces_sampled:
      description: Count of traces that were sampled or not per sampling policy
      unit: "{traces}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [policy, sampled, decision]

    processor_tail_sampling_count_spans_sampled:
      description: Count of spans that were sampled or not per sampling policy
      unit: "{spans}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [policy, sampled, decision]

    processor_tail_sampling_global_count_traces_sampled:
      description: Global count of traces that were sampled or not by at least one policy
      unit: "{traces}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [sampled, decision]

    processor_tail_sampling_sampling_trace_dropped_too_early:
      description: Count of traces that needed to be dropped before the configured wait time
      unit: "{traces}"
      enabled: true
      sum:
        value_type: int
        monotonic: true

    processor_tail_sampling_new_trace_id_received:
      description: Counts the arrival of new traces
      unit: "{traces}"
      enabled: true
      sum:
        value_type: int
        monotonic: true

    processor_tail_sampling_sampling_traces_on_memory:
      description: Tracks the number of traces current on memory
      unit: "{traces}"
      enabled: true
      gauge:
        value_type: int

    processor_tail_sampling_early_releases_from_cache_decision:
      description: Number of spans that were able to be immediately released due to a decision cache hit.
      unit: "{spans}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [sampled]

    # Storage-specific metrics for distributed tail sampling

    processor_tail_sampling_redis_operations_total:
      description: Total number of Redis operations performed
      unit: "{operations}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [operation]

    processor_tail_sampling_redis_operation_duration:
      description: Duration of Redis operations in microseconds
      unit: µs
      enabled: true
      histogram:
        value_type: int
        bucket_boundaries: [100, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000]
      attributes: [operation]

    processor_tail_sampling_spill_segments_created_total:
      description: Total number of object storage segments created for spill operations
      unit: "{segments}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [backend]

    processor_tail_sampling_spill_operation_duration:
      description: Duration of spill write operations in milliseconds
      unit: ms
      enabled: true
      histogram:
        value_type: int
        bucket_boundaries: [10, 25, 50, 100, 250, 500, 1000, 2500, 5000, 10000, 20000]
      attributes: [backend]

    processor_tail_sampling_lease_acquisitions_total:
      description: Total number of trace lease acquisitions attempted
      unit: "{leases}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [storage_type]

    processor_tail_sampling_lease_contentions_total:
      description: Total number of lease contentions (failed acquisitions due to existing lease)
      unit: "{contentions}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [storage_type]

    processor_tail_sampling_storage_errors_total:
      description: Total number of storage operation errors
      unit: "{errors}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [storage_type, operation, error_type]

    processor_tail_sampling_decision_cache_hits_total:
      description: Total number of sampling decision cache hits
      unit: "{hits}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [storage_type]

    processor_tail_sampling_rehydration_operations_total:
      description: Total number of trace rehydration operations from object storage
      unit: "{operations}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [backend]

    processor_tail_sampling_rehydration_spans_total:
      description: Total number of spans rehydrated from object storage
      unit: "{spans}"
      enabled: true
      sum:
        value_type: int
        monotonic: true
      attributes: [backend]

    processor_tail_sampling_active_traces_by_storage:
      description: Number of active traces per storage type
      unit: "{traces}"
      enabled: true
      gauge:
        value_type: int
      attributes: [storage_type]

    processor_tail_sampling_storage_bytes_used:
      description: Approximate bytes used by storage backend
      unit: By
      enabled: true
      gauge:
        value_type: int
      attributes: [storage_type]
